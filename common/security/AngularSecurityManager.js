/**
 * Angular Security.
 * @author Nikhil
 * @version: 1.5.0
 */
angular.module("AngularSecurityManagerConstants",[]).constant("INTERCEPT_STRATEGY",{PUBLIC:"public",IS_AUTHENTICATED:"is_authenticated",ROLES:"roles"}).constant("ACCESS_TYPE",{HAS_ANY_ROLE:"hasAnyRole",HAS_ROLE:"hasRole",HAS_NO_ROLES:"hasNoRoles"}).constant("HTTP_STATUS",{UN_AUTHORIZE:401,FORBIDDEN:403,OK:200,SERVER_ERROR:500}),angular.module("AngularSecurityManager",[]).run(["$rootScope","AngularSecurityManager","$state",function(a,b,c){a.$on("$stateChangeStart",function(a,c,d,e,f){b.intercept(a,c,d)})}]).factory("AngularSecurityUtils",function(){return{intersectionObject:function(a,b,c){return _.filter(a,function(a){return _.contains(c,a[b])})}}}).provider("AngularSecurityManager",[function(){function a(){return d}function b(a){c(a),d=angular.extend({},d,a)}function c(a){if(!(a&&a.userAuthService&&a.unAuthroizeState&&a.forbiddenState))throw new Error("Invalid configuration.")}var d={userAuthService:"UserAuthService",unAuthroizeState:"signin",forbiddenState:"403"};this.getConfig=a,this.setConfig=b,this.$get=["$http","$injector","$state","INTERCEPT_STRATEGY","ACCESS_TYPE","AngularSecurityUtils",function(b,c,d,e,f,g){var h=c.get(a().userAuthService),i=!1,j=a();return{getConfig:a,intercept:function(a,b,c){var g=this,k=h.isAuthenticated();if(b.params&&b.params.access){var l=b.params.access;if(l["public"]===!0||i)return void(k||(i=!1,a.preventDefault(),d.go(j.unAuthroizeState)));if(a.preventDefault(),k){var m=b.params.access.authStrategy;if(m){if(e.IS_AUTHENTICATED===m)return i=!0,void d.go(b,c);var n=h.getAuthenticatedUser();if(n){var o=b.params.access.accessType,p=b.params.access.hasRoles;i=o===f.HAS_ANY_ROLE?g.hasAnyRole(n,p):o===f.HAS_ROLE?g.hasRole(n,p):g.hasNoRoles(n,p)}else i=!1;if(i)return i=!0,void d.go(b,c);i=!1,d.go(j.forbiddenState)}}else d.go(j.unAuthroizeState)}},hasRole:function(a,b){var c=!1;return a.authorities&&(c=g.intersectionObject(a.authorities,"authority",b).length==b.length),c},hasNoRoles:function(a,b){var c=!0;return a.authorities&&(c=0===g.intersectionObject(a.authorities,"authority",b).length),c},hasAnyRole:function(a,b){var c=!1;return a.authorities&&(c=g.intersectionObject(a.authorities,"authority",b).length>0),c},changeState:function(b){b||d.go(a().unAuthroizeState)}}}]}]).directive("authorize",["$injector","AngularSecurityManager","ACCESS_TYPE",function(a,b,c){return{restrict:"E",template:'<div ng-if="display"><ng-transclude></ng-transclude></div>',priority:1e3,transclude:!0,scope:{accessType:"="},link:function(d,e,f,g){var h=a.get(b.getConfig().userAuthService);d.$watch(f.access,function(a,e){if(d.display=!1,a){var f=h.getAuthenticatedUser();f&&h.isAuthenticated()&&(a.length?d.accessType&&(d.accessType===c.HAS_ANY_ROLE?d.display=b.hasAnyRole(f,a):d.accessType===c.HAS_ROLE?d.display=b.hasRole(f,a):d.display=b.hasNoRoles(f,a)):d.display=!1)}})}}}]);